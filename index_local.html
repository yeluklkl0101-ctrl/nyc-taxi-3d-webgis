<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>CityPulse AI - åŸå¸‚è„‰æ</title>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet" />
    <style>
        body { margin: 0; padding: 0; background: #000; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        #container { width: 100vw; height: 100vh; }
        
        /* === å·¦ä¾§æ§åˆ¶é¢æ¿ === */
        #control-panel {
            position: absolute; top: 20px; left: 20px; width: 320px;
            background: rgba(10, 10, 10, 0.9); 
            border: 1px solid rgba(0, 255, 204, 0.3);
            border-radius: 12px; padding: 15px; z-index: 10; color: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.6);
            backdrop-filter: blur(8px);
        }
        h2 { margin: 0 0 10px 0; font-size: 18px; color: #00ffcc; text-transform: uppercase; letter-spacing: 1px; }
        
        /* ç”¨æˆ·ä¿¡æ¯ */
        .user-info { font-size: 12px; color: #aaa; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 5px; display:flex; justify-content:space-between; }
        .logout { color: #ff3366; cursor: pointer; text-decoration: underline; }

        /* æ—¶é—´æ˜¾ç¤º */
        #clock-display { font-size: 20px; font-weight: bold; color: #fff; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 5px; }

        /* åˆ†æçŠ¶æ€æç¤ºæ¡ */
        #analysis-status {
            display: none; margin-top: 10px; padding: 8px; 
            background: rgba(0, 100, 255, 0.2); border: 1px solid #0088ff; border-radius: 4px;
            font-size: 12px; color: #88ccff;
        }

        /* æ§ä»¶æ ·å¼ */
        select { background: #222; color: #fff; border: 1px solid #444; width: 100%; margin-bottom: 10px; padding: 5px; border-radius: 4px; }
        button { background: #333; color: white; border: 1px solid #555; padding: 6px 12px; border-radius: 4px; cursor: pointer; transition: 0.2s; }
        button:hover { background: #00ffcc; color: black; }
        input[type=range] { width: 100%; accent-color: #00ffcc; margin-top: 5px; }

        /* å®æ—¶æ¨¡å¼å¼€å…³ */
        .toggle-container { margin-top: 15px; padding-top: 10px; border-top: 1px dashed #444; display: flex; align-items: center; justify-content: space-between; }
        #realtime-toggle { accent-color: #ff3366; width: 16px; height: 16px; cursor: pointer; }

        /* === å³ä¸Šè§’ç®¡ç†å‘˜é¢æ¿ === */
        #admin-panel {
            display: none; /* é»˜è®¤éšè— */
            position: absolute; top: 20px; right: 20px; width: 260px;
            background: rgba(20, 0, 10, 0.95); border: 1px solid #ff0055;
            padding: 15px; z-index: 100; color: white; border-radius: 8px;
            box-shadow: 0 0 15px rgba(255, 0, 85, 0.3);
        }
        #admin-panel h3 { margin: 0 0 10px 0; color: #ff0055; font-size: 14px; text-transform: uppercase; }
        #upload-btn { background: #ff0055; width: 100%; border: none; font-weight: bold; margin-top: 10px; }
        #upload-btn:hover { background: #ff3366; color: white; }

        /* === åº•éƒ¨ AI èŠå¤©é¢æ¿ === */
        #ai-panel {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 500px; height: 400px; 
            background: rgba(20, 25, 30, 0.95); backdrop-filter: blur(10px);
            border: 1px solid #00ffcc; border-radius: 16px; 
            box-shadow: 0 0 30px rgba(0, 255, 204, 0.2);
            display: flex; flex-direction: column; z-index: 20; padding: 15px;
        }
        #chat-history { flex: 1; overflow-y: auto; margin-bottom: 10px; padding-right: 5px; }
        
        /* èŠå¤©æ°”æ³¡ */
        .msg { padding: 8px 12px; margin: 6px 0; border-radius: 8px; font-size: 14px; line-height: 1.4; max-width: 85%; word-wrap: break-word; }
        .msg.user { background: #005f4c; color: white; align-self: flex-end; margin-left: auto; text-align: right; }
        .msg.ai { background: #333; color: #00ffcc; align-self: flex-start; border: 1px solid #444; }
        
        /* è¾“å…¥åŒº */
        .input-area { display: flex; gap: 10px; }
        #ai-input { flex: 1; background: rgba(0,0,0,0.3); border: 1px solid #555; color: white; padding: 10px; border-radius: 4px; outline: none; }
        #ai-input:focus { border-color: #00ffcc; }
        #send-btn { background: #00ffcc; color: black; border: none; font-weight: bold; }
    </style>
</head>
<body>
    <div id="container"></div>

    <div id="control-panel">
        <h2>CityPulse AI Â· åŸå¸‚è„‰æ</h2>
        <div class="user-info">
            <span id="username-display">æ£€æµ‹ä¸­...</span>
            <span class="logout" onclick="logout()">[é€€å‡º]</span>
        </div>
        
        <div id="clock-display">Loading...</div>
        
        <div id="analysis-status">
            <span id="analysis-msg"></span>
            <button onclick="resetData()" style="float:right; font-size:10px; padding:2px 5px; margin-top:-2px;">é‡ç½®è§†å›¾</button>
        </div>

        <div style="margin-top:10px;">
            <label>é€‰æ‹©æ—¥æœŸï¼š</label> 
            <select id="date-selector"></select>
        </div>
        
        <div style="margin-top:10px; display:flex; align-items:center;">
            <button id="play-btn" style="margin-right:10px; width: 40px;">â¸</button>
            <input type="range" id="time-slider" min="0" max="86400" step="10" value="0" style="flex:1;">
        </div>

        <div class="toggle-container">
            <span style="font-weight:bold; color:#ff3366;">ğŸ”´ å®æ—¶å«æ˜Ÿæ¨¡å¼</span>
            <input type="checkbox" id="realtime-toggle">
        </div>
    </div>

    <div id="admin-panel">
        <h3>ğŸ”’ æ•°æ®è¿ç»´ä¸­å¿ƒ</h3>
        <label style="font-size:12px; color:#aaa;">æ—¥æœŸ (YYYY-MM-DD):</label>
        <input type="date" id="upload-date" style="width:100%; margin-bottom:5px; background:#333; color:white; border:1px solid #555;">
        <label style="font-size:12px; color:#aaa;">æ•°æ®æ–‡ä»¶ (JSON):</label>
        <input type="file" id="upload-file" accept=".json" style="width:100%; margin-bottom:10px; font-size:12px;">
        <button id="upload-btn" onclick="uploadData()">ä¸Šä¼ å½’æ¡£æ•°æ®</button>
        <div id="upload-status" style="font-size:12px; margin-top:5px; color:#ccc;"></div>
    </div>

    <div id="ai-panel">
        <div id="chat-history"></div>
        <div class="input-area">
            <input type="text" id="ai-input" placeholder="âœ¨ æŒ‡ä»¤: 'åˆ†æèšç±»' æˆ– 'å»æ—¶ä»£å¹¿åœº'..." autocomplete="off">
            <button id="send-btn" onclick="askAI()">å‘é€</button>
        </div>
    </div>

    <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
    <script src="https://unpkg.com/deck.gl@8.9.33/dist.min.js"></script>

    <script>
        const {DeckGL, ArcLayer, ScatterplotLayer, DataFilterExtension, FlyToInterpolator} = deck;
        // æ›¿æ¢ä½ çš„ Token
        const MAPBOX_TOKEN = 'pk.eyJ1IjoiMWRjajQiLCJhIjoiY21nNWN0ZXhwMDNjbTJqcWQ0aHR5NW5zcyJ9.Op7DM_smqoPKJVf2te3HQw'; 
        const API_BASE = "http://127.0.0.1:5000/api"; 

        // å…¨å±€çŠ¶æ€å˜é‡
        let fullDailyData = [];   // å½“æ—¥å…¨é‡æ•°æ®
        let displayData = [];     // å½“å‰ç”¨äºæ˜¾ç¤ºçš„æ•°æ® (å¯èƒ½æ˜¯ç­›é€‰åçš„)
        let clusterData = [];     // èšç±»ä¸­å¿ƒç‚¹æ•°æ®
        
        let currentTime = 0;
        let isPlaying = true;
        let isRealTimeMode = false;
        let deckgl = null;
        
        // é»˜è®¤è§†è§’
        let currentViewState = { longitude: -73.98, latitude: 40.75, zoom: 11, pitch: 0, bearing: 0 };

        // 1. åˆå§‹åŒ–ç¨‹åº
        async function init() {
            // é‰´æƒæ£€æŸ¥
            try {
                const res = await fetch(`${API_BASE}/check_auth`, {credentials: 'include'});
                const auth = await res.json();
                
                if (!auth.is_logged_in) {
                    window.location.href = 'login.html';
                    return;
                }
                
                // æ›´æ–° UI ç”¨æˆ·å
                document.getElementById('username-display').innerText = `${auth.username} (${auth.role})`;
                
                //å¦‚æœæ˜¯ç®¡ç†å‘˜ï¼Œæ˜¾ç¤ºåå°
                if (auth.role === 'admin') {
                    document.getElementById('admin-panel').style.display = 'block';
                }
                
                // åˆå§‹åŒ–å„ç»„ä»¶
                initDeckGL();
                await initDateSelector();
                loadHistory(); // åŠ è½½èŠå¤©è®°å½•
                
            } catch(e) {
                console.error("Auth Check Failed", e);
                document.getElementById('username-display').innerText = "ç¦»çº¿æ¨¡å¼/è¿æ¥å¤±è´¥";
            }
        }

        async function logout() {
            await fetch(`${API_BASE}/logout`, {method:'POST', credentials:'include'});
            window.location.href = 'login.html';
        }

        // 2. åœ°å›¾æ¸²æŸ“æ ¸å¿ƒ
        function initDeckGL() {
            deckgl = new DeckGL({
                container: 'container', 
                mapboxApiAccessToken: MAPBOX_TOKEN,
                mapStyle: 'mapbox://styles/mapbox/dark-v10',
                viewState: currentViewState,
                onViewStateChange: ({viewState}) => {
                    currentViewState = viewState;
                    deckgl.setProps({viewState: currentViewState});
                },
                controller: true,
                layers: []
            });
            // å¯åŠ¨åŠ¨ç”»å¾ªç¯
            animate();
        }

        function updateDeckGL() {
            const layers = [];

            // å›¾å±‚ A: è½¨è¿¹æµ (ArcLayer)
            if (displayData.length > 0 && !isRealTimeMode) {
                layers.push(new ArcLayer({
                    id: 'taxi-arcs', 
                    data: displayData,
                    getSourcePosition: d => d.from, 
                    getTargetPosition: d => d.to,
                    getSourceColor: [0, 255, 200], 
                    getTargetColor: [255, 0, 100],
                    getWidth: 2,
                    // å¦‚æœå¤„äºåˆ†æçŠ¶æ€(æ•°æ®é‡å°‘)ï¼Œæˆ–è€…ä¸æƒ³è¿‡æ»¤æ—¶é—´ï¼Œå¯ä»¥è°ƒæ•´è¿™é‡Œ
                    extensions: [new DataFilterExtension({filterSize: 1})],
                    getFilterValue: d => d.time, 
                    filterRange: [currentTime, currentTime + 3600], // æ˜¾ç¤ºå½“å‰æ—¶é—´å1å°æ—¶å†…çš„è½¦
                    opacity: 0.8
                }));
            }

            // å›¾å±‚ B: èšç±»çƒ­ç‚¹ (ScatterplotLayer)
            if (clusterData.length > 0) {
                layers.push(new ScatterplotLayer({
                    id: 'cluster-layer',
                    data: clusterData,
                    getPosition: d => d, 
                    getRadius: 300,
                    getFillColor: [255, 255, 0], // é»„è‰²
                    stroked: true,
                    getLineColor: [255, 0, 0],   // çº¢è¾¹
                    lineWidthMinPixels: 2,
                    radiusMinPixels: 5
                }));
            }

            deckgl.setProps({ layers: layers });
        }

        // 3. åŠ¨ç”»ä¸æ—¶é—´æ§åˆ¶
        function animate() {
            if (isPlaying && !isRealTimeMode) {
                currentTime = (currentTime + 60) % 86400; // æ¯æ¬¡+60ç§’
                
                // æ›´æ–° DOM æ§ä»¶
                document.getElementById('time-slider').value = currentTime;
                document.getElementById('clock-display').innerText = formatTime(currentTime);
                
                updateDeckGL(); // åˆ·æ–° FilterRange
            } else if (isRealTimeMode) {
                document.getElementById('clock-display').innerText = "ğŸ”´ LIVE SATELLITE FEED";
            }
            requestAnimationFrame(animate);
        }

        function formatTime(s) {
            // æŠŠç§’æ•°è½¬ä¸º HH:MM:SS
            return new Date(s * 1000).toISOString().substr(11, 8);
        }

        // 4. æ•°æ®åŠ è½½é€»è¾‘
        async function loadData(date) {
            try {
                const res = await fetch(`${API_BASE}/get_trips?date=${date}`, {credentials: 'include'});
                fullDailyData = await res.json();
                resetData(); // é»˜è®¤æ˜¾ç¤ºå…¨éƒ¨
            } catch(e) { console.error(e); }
        }

        function resetData() {
            displayData = fullDailyData; 
            clusterData = [];
            document.getElementById('analysis-status').style.display = 'none';
            addMessageToUI("ç³»ç»Ÿ: è§†å›¾å·²é‡ç½®ã€‚", "ai");
            updateDeckGL();
        }

        // 5. AI äº¤äº’é€»è¾‘ (DeepSeek)
        async function askAI() {
            const input = document.getElementById('ai-input');
            const prompt = input.value.trim();
            if(!prompt) return;
            
            addMessageToUI(prompt, 'user');
            input.value = '';
            
            const dateStr = document.getElementById('date-selector').value;
            
            try {
                const res = await fetch(`${API_BASE}/chat_with_ai`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify({ 
                        message: prompt, 
                        date: dateStr, 
                        mode: isRealTimeMode ? 'realtime' : 'history' 
                    })
                });
                const data = await res.json();
                
                // è§£æ AI è¿”å›çš„ Markdown/JSON
                let cleanJson = data.reply.replace(/```json/g, "").replace(/```/g, "").trim();
                
                try {
                    const cmd = JSON.parse(cleanJson);
                    
                    // 1. æ˜¾ç¤º AI çš„å£è¯­å›å¤
                    if(cmd.text) addMessageToUI(cmd.text, 'ai');

                    // 2. æ‰§è¡Œ GIS åŠ¨ä½œ
                    if (cmd.action === 'kmeans') {
                        // è°ƒç”¨åç«¯ K-Means
                        const kRes = await fetch(`${API_BASE}/analyze/kmeans?date=${dateStr}&k=5`, {credentials:'include'});
                        const kData = await kRes.json();
                        clusterData = kData.centers;
                        showStatus("ğŸ“Š K-Means èšç±»çƒ­ç‚¹å±•ç¤ºä¸­");
                    }
                    else if (cmd.action === 'buffer' || cmd.action === 'od') {
                        // è°ƒç”¨åç«¯ ç¼“å†²åŒº/OD
                        const api = cmd.action === 'buffer' ? '/analyze/buffer' : '/analyze/od';
                        const payload = { date: dateStr, center: cmd.center, radius: cmd.radius, type: cmd.type };
                        
                        const aRes = await fetch(`${API_BASE}${api}`, {
                            method: 'POST', headers: {'Content-Type': 'application/json'}, credentials:'include',
                            body: JSON.stringify(payload)
                        });
                        const aData = await aRes.json();
                        displayData = aData.trips; // ä»…æ˜¾ç¤ºç­›é€‰åçš„æ•°æ®
                        showStatus(`ğŸ” ç­›é€‰ç»“æœ: ${aData.count} æ¡è®°å½•`);
                        
                        // é£è¿‡å»
                        flyTo(cmd.center, 14);
                    }
                    else if (cmd.action === 'flyTo') {
                        flyTo(cmd.center, cmd.zoom);
                    }
                    
                    updateDeckGL();

                } catch (jsonErr) {
                    // å¦‚æœä¸æ˜¯ JSONï¼Œç›´æ¥æ˜¾ç¤ºæ™®é€šæ–‡æœ¬
                    addMessageToUI(data.reply, 'ai');
                }
            } catch(e) {
                addMessageToUI("âŒ è¿æ¥ AI æœåŠ¡å¤±è´¥", 'ai');
            }
        }

        // 6. è¾…åŠ© UI å‡½æ•°
        async function initDateSelector() {
            const res = await fetch(`${API_BASE}/get_available_dates`, {credentials:'include'});
            const dates = await res.json();
            const sel = document.getElementById('date-selector');
            sel.innerHTML = '';
            
            if (dates.length === 0) {
                sel.add(new Option("æ— æ•°æ®", ""));
                return;
            }

            dates.forEach(d => sel.add(new Option(d, d)));
            
            // åŠ è½½ç¬¬ä¸€å¤©
            loadData(dates[0]);
            
            // ç›‘å¬åˆ‡æ¢
            sel.onchange = () => loadData(sel.value);
        }

        async function uploadData() {
            const d = document.getElementById('upload-date').value;
            const f = document.getElementById('upload-file').files[0];
            const status = document.getElementById('upload-status');
            
            if(!d || !f) return alert("è¯·é€‰æ‹©æ—¥æœŸå’Œæ–‡ä»¶");
            
            const fd = new FormData();
            fd.append('file', f);
            fd.append('date', d);
            
            status.innerText = "ä¸Šä¼ ä¸­...";
            try {
                const res = await fetch(`${API_BASE}/upload_data`, {method:'POST', body:fd, credentials:'include'});
                const data = await res.json();
                if(data.status === 'success') {
                    status.innerText = "âœ… ä¸Šä¼ æˆåŠŸ";
                    initDateSelector(); // åˆ·æ–°ä¸‹æ‹‰æ¡†
                } else {
                    status.innerText = "âŒ " + data.error;
                }
            } catch(e) { status.innerText = "âŒ ç½‘ç»œé”™è¯¯"; }
        }

        async function loadHistory() {
            try {
                const res = await fetch(`${API_BASE}/chat`, {credentials:'include'});
                const msgs = await res.json();
                msgs.forEach(m => {
                    // å°è¯•æå– JSON ä¸­çš„ text å­—æ®µï¼Œå¦‚æœä¸æ˜¯ JSON åˆ™ç›´æ¥æ˜¾ç¤º
                    try {
                        const txt = JSON.parse(m.content.replace(/```json|```/g, "").trim()).text;
                        if(txt) addMessageToUI(txt, m.role);
                        else addMessageToUI(m.content, m.role);
                    } catch { addMessageToUI(m.content, m.role); }
                });
            } catch(e) {}
        }

        function addMessageToUI(text, role) {
            const div = document.createElement('div');
            div.className = `msg ${role}`;
            div.innerHTML = text.replace(/\n/g, '<br>'); // æ”¯æŒæ¢è¡Œ
            const box = document.getElementById('chat-history');
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        function showStatus(text) {
            const div = document.getElementById('analysis-status');
            div.style.display = 'block';
            document.getElementById('analysis-msg').innerText = text;
        }

        function flyTo(center, zoom) {
            currentViewState = {
                ...currentViewState,
                longitude: center[0],
                latitude: center[1],
                zoom: zoom || 14,
                transitionDuration: 2000,
                transitionInterpolator: new FlyToInterpolator()
            };
            deckgl.setProps({viewState: currentViewState});
        }

        // === âš¡ï¸ äº‹ä»¶ç›‘å¬ç»‘å®š (ä¹‹å‰ç¼ºå¤±çš„éƒ¨åˆ†) ===
        
        // æ’­æ”¾/æš‚åœæŒ‰é’®
        const playBtn = document.getElementById('play-btn');
        playBtn.onclick = () => {
            isPlaying = !isPlaying;
            playBtn.innerText = isPlaying ? "â¸" : "â–¶";
        };

        // æ—¶é—´æ»‘å—æ‹–åŠ¨
        const slider = document.getElementById('time-slider');
        slider.addEventListener('input', (e) => {
            currentTime = parseInt(e.target.value);
            // æ‹–åŠ¨æ—¶æš‚åœä¸€ä¸‹ä½“éªŒæ›´å¥½ï¼Œæˆ–è€…ç›´æ¥æ›´æ–°
            updateDeckGL();
        });

        // å®æ—¶æ¨¡å¼å¼€å…³
        const toggle = document.getElementById('realtime-toggle');
        toggle.onchange = (e) => {
            isRealTimeMode = e.target.checked;
            const map = deckgl.getMapboxMap();
            if(isRealTimeMode) {
                map.setStyle('mapbox://styles/mapbox/satellite-streets-v12');
                playBtn.disabled = true;
                addMessageToUI("å·²åˆ‡æ¢è‡³å®æ—¶å«æ˜Ÿæ¨¡å¼ (3D)", "ai");
            } else {
                map.setStyle('mapbox://styles/mapbox/dark-v10');
                playBtn.disabled = false;
                addMessageToUI("å·²åˆ‡æ¢è‡³å†å²æ•°æ®æ¨¡å¼", "ai");
            }
            updateDeckGL();
        };

        // å›è½¦å‘é€æ¶ˆæ¯
        document.getElementById('ai-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') askAI();
        });

        // å¯åŠ¨ï¼
        init();

    </script>
</body>
</html>