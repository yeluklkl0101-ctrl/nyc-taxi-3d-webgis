<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>NYC Taxi + Gemini AI</title>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet" />
    <style>
        body { margin: 0; padding: 0; background: #000; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        #container { width: 100vw; height: 100vh; }
        
        /* === åŸæœ‰æ§ä»¶æ ·å¼ä¿æŒä¸å˜ === */
        #control-panel {
            position: absolute; top: 20px; left: 20px; /* ç§»åˆ°å·¦ä¸Šè§’ï¼Œç»™AIè…¾ä½ç½® */
            width: 300px;
            background: rgba(10, 10, 10, 0.8);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            padding: 15px;
            z-index: 10;
            color: white;
        }
        select { background: #222; color: #fff; border: 1px solid #444; width: 100%; margin-bottom: 10px; padding: 5px; }
        #clock-display { font-size: 20px; font-weight: bold; color: #00ffcc; margin-bottom: 10px; }
        button { background: #eee; border: none; padding: 5px 15px; border-radius: 4px; cursor: pointer; }
        input[type=range] { width: 100%; accent-color: #00ffcc; }

        /* === ğŸ¤– æ–°å¢ï¼šAI å¯¹è¯é¢æ¿æ ·å¼ === */
        #ai-panel {
            position: absolute; 
            bottom: 30px; 
            left: 50%; 
            transform: translateX(-50%); /* å±…ä¸­ */
            width: 400px;
            max-height: 500px;
            background: rgba(20, 25, 30, 0.95); /* æ·±è‰²ç£¨ç ‚ç»ç’ƒ */
            backdrop-filter: blur(10px);
            border: 1px solid #00ffcc;
            border-radius: 16px;
            box-shadow: 0 0 30px rgba(0, 255, 204, 0.2);
            z-index: 20;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        /* èŠå¤©è®°å½•åŒºåŸŸ */
        #chat-history {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            max-height: 300px;
            font-size: 14px;
            color: #ddd;
            display: none; /* é»˜è®¤éšè—å†å²ï¼Œåªæ˜¾ç¤ºè¾“å…¥æ¡† */
        }
        
        /* æ¶ˆæ¯æ°”æ³¡ */
        .msg { margin-bottom: 10px; padding: 8px 12px; border-radius: 12px; max-width: 80%; line-height: 1.4; }
        .msg.user { background: #005f4c; color: white; align-self: flex-end; margin-left: auto; text-align: right;}
        .msg.ai { background: #333; color: #00ffcc; align-self: flex-start; border: 1px solid #444; }

        /* è¾“å…¥æ¡†åŒºåŸŸ */
        #input-area {
            display: flex;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        #ai-input {
            flex-grow: 1;
            background: transparent;
            border: none;
            color: white;
            outline: none;
            font-size: 15px;
        }
        #send-btn {
            background: transparent;
            color: #00ffcc;
            border: 1px solid #00ffcc;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            margin-left: 10px;
            transition: 0.2s;
        }
        #send-btn:hover { background: #00ffcc; color: black; }
        
        /* åŠ è½½åŠ¨ç”» */
        .typing { font-style: italic; color: #888; font-size: 12px; margin-left: 15px; display: none; }
    </style>
    
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>
</head>
<body>

    <div id="container"></div>

    <div id="control-panel">
        <div id="clock-display">2025.07.01 00:00</div>
        <select id="date-selector"></select>
        <div style="display:flex; gap:10px; align-items:center;">
            <button id="play-btn">â¸</button>
            <input type="range" id="time-slider" min="0" max="86400" step="10" value="0">
        </div>
        <div style="font-size:12px; color:#aaa; margin-top:5px;">æ‹–åŠ¨æ»‘å—æŸ¥çœ‹ä¸åŒæ—¶é—´æ®µ</div>
    </div>

    <div id="ai-panel">
        <div id="chat-history">
            <div class="msg ai">ä½ å¥½ï¼æˆ‘æ˜¯çº½çº¦äº¤é€š AI åŠ©æ‰‹ã€‚ä½ å¯ä»¥é—®æˆ‘ï¼š<br>â€œç°åœ¨çš„äº¤é€šçŠ¶å†µå¦‚ä½•ï¼Ÿâ€<br>â€œå“ªä¸ªåŒºåŸŸæœ€æ‹¥å µï¼Ÿâ€</div>
        </div>
        <div class="typing" id="typing-indicator">Gemini æ­£åœ¨æ€è€ƒ...</div>
        <div id="input-area">
            <input type="text" id="ai-input" placeholder="âœ¨ è¯¢é—® AI å…³äºå½“å‰çš„äº¤é€šæ•°æ®..." autocomplete="off">
            <button id="send-btn">å‘é€</button>
        </div>
    </div>

    <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
    <script src="https://unpkg.com/deck.gl@8.9.33/dist.min.js"></script>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // ============================================
        // ğŸ”‘åœ¨æ­¤å¤„å¡«å…¥ä½ çš„ API KEY (æ³¨æ„å®‰å…¨)
        // ============================================
        const API_KEY = "AIzaSyBD5-mYSR2G-k2-5KsnKoab-ulS3LwR5iQ"; 
        // ============================================

        const genAI = new GoogleGenerativeAI(API_KEY);
        const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

        // --- AI äº¤äº’é€»è¾‘ ---
        const chatHistory = document.getElementById('chat-history');
        const aiInput = document.getElementById('ai-input');
        const sendBtn = document.getElementById('send-btn');
        const typingIndicator = document.getElementById('typing-indicator');
        const aiPanel = document.getElementById('ai-panel');

        // å‘é€æ¶ˆæ¯
        async function askGemini() {
            const prompt = aiInput.value.trim();
            if (!prompt) return;

            // 1. æ˜¾ç¤ºç”¨æˆ·æé—®
            chatHistory.style.display = "block"; // å±•å¼€èŠå¤©è®°å½•
            addMessage(prompt, 'user');
            aiInput.value = '';
            typingIndicator.style.display = 'block';

            // 2. æ„é€ ä¸Šä¸‹æ–‡æç¤ºè¯ (è®© AI çŸ¥é“å®ƒæ˜¯ä¸ªäº¤é€šä¸“å®¶)
            // è¿™é‡Œæˆ‘ä»¬æŠŠå½“å‰çš„æ—¥æœŸå’Œæ—¶é—´ä¼ ç»™ AIï¼Œè®©å®ƒå‡è£…åœ¨åˆ†æ
            const context = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ WebGIS äº¤é€šåˆ†æåŠ©æ‰‹ã€‚
            å½“å‰å±•ç¤ºçš„æ•°æ®æ˜¯ 2025å¹´7æœˆçº½çº¦å‡ºç§Ÿè½¦è½¨è¿¹æ•°æ®ã€‚
            å½“å‰ç”»é¢æ˜¾ç¤ºçš„æ—¶é—´æ˜¯ï¼š${document.getElementById('clock-display').innerText}ã€‚
            
            å¦‚æœç”¨æˆ·é—®äº¤é€šçŠ¶å†µï¼Œè¯·æ ¹æ®å½“å‰æ—¶é—´ï¼ˆæ—©é«˜å³°ã€æ™šé«˜å³°ã€æ·±å¤œç­‰ï¼‰è¿›è¡Œåˆç†çš„æ¨æµ‹å’Œå›ç­”ã€‚
            å›ç­”è¦ç®€çŸ­ã€ä¸“ä¸šï¼Œä¸è¦è¶…è¿‡ 100 å­—ã€‚
            
            ç”¨æˆ·çš„é—®é¢˜æ˜¯ï¼š${prompt}`;

            try {
                // 3. è°ƒç”¨ API
                const result = await model.generateContent(context);
                const response = await result.response;
                const text = response.text();
                
                // 4. æ˜¾ç¤º AI å›ç­”
                typingIndicator.style.display = 'none';
                addMessage(text, 'ai');
            } catch (error) {
                console.error(error);
                typingIndicator.style.display = 'none';
                addMessage("âŒ è¿æ¥ AI å¤±è´¥ï¼Œè¯·æ£€æŸ¥ API Key æˆ–ç½‘ç»œã€‚", 'ai');
            }
        }

        function addMessage(text, sender) {
            const div = document.createElement('div');
            div.className = `msg ${sender}`;
            div.innerHTML = text.replace(/\n/g, '<br>'); // æ”¯æŒæ¢è¡Œ
            chatHistory.appendChild(div);
            chatHistory.scrollTop = chatHistory.scrollHeight; // æ»šåŠ¨åˆ°åº•éƒ¨
        }

        // ç»‘å®šäº‹ä»¶
        sendBtn.addEventListener('click', askGemini);
        aiInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') askGemini(); });
        
        // ç‚¹å‡»è¾“å…¥æ¡†æ—¶è‡ªåŠ¨å±•å¼€å†å²
        aiInput.addEventListener('focus', () => { chatHistory.style.display = "block"; });


        // --- ä»¥ä¸‹æ˜¯åŸæœ‰çš„åœ°å›¾é€»è¾‘ (ä¸éœ€è¦å¤§æ”¹) ---
        const {DeckGL, ArcLayer, DataFilterExtension} = deck;
        const MAPBOX_TOKEN = 'pk.eyJ1IjoiMWRjajQiLCJhIjoiY21nNWN0ZXhwMDNjbTJqcWQ0aHR5NW5zcyJ9.Op7DM_smqoPKJVf2te3HQw'; 

        // å…¨å±€å˜é‡
        let currentDateStr = "2025-07-01"; 
        let currentTime = 0;              
        let isPlaying = true;
        let animationSpeed = 10;
        const timeWindow = 3600;
        
        let deckgl = null; 
        
        const dateSelect = document.getElementById('date-selector');
        const clockDisplay = document.getElementById('clock-display');
        const slider = document.getElementById('time-slider');
        const playBtn = document.getElementById('play-btn');

        function initDateSelector() {
            for (let i = 1; i <= 31; i++) {
                const dayStr = i < 10 ? `0${i}` : `${i}`;
                const val = `2025-07-${dayStr}`;
                const option = document.createElement("option");
                option.value = val;
                option.text = val;
                dateSelect.appendChild(option);
            }
            dateSelect.addEventListener('change', (e) => loadDataForDate(e.target.value));
        }

        
        function loadDataForDate(dateStr) {
            currentDateStr = dateStr;
            const fileName = `./trips_${dateStr}.json`;
            fetch(fileName)
                .then(res => {
                    if(!res.ok) throw new Error("File not found");
                    return res.json();
                })
                .then(data => {
                    updateDeckGL(data);
                })
                .catch(err => {
                    console.error(err);
                    updateDeckGL([]); 
                });
        }

        function updateDeckGL(data) {
            if (!deckgl) {
                deckgl = new DeckGL({
                    container: 'container',
                    mapboxApiAccessToken: MAPBOX_TOKEN,
                    mapStyle: 'mapbox://styles/mapbox/dark-v10',
                    initialViewState: {
                        longitude: -73.98, latitude: 40.75, zoom: 11, pitch: 50, bearing: -10
                    },
                    controller: true,
                    layers: []
                });
                requestAnimationFrame(animate); 
            }

            const layer = new ArcLayer({
                id: 'taxi-arcs',
                data: data,
                getSourcePosition: d => d.from,
                getTargetPosition: d => d.to,
                getSourceColor: [0, 255, 200],
                getTargetColor: [255, 0, 100],
                getWidth: 2,
                extensions: [new DataFilterExtension({filterSize: 1})],
                getFilterValue: d => d.time,
                filterRange: [currentTime, currentTime + timeWindow], 
                opacity: 0.8
            });

            deckgl.setProps({ layers: [layer] });
        }

        function animate() {
            if (isPlaying) {
                currentTime += animationSpeed;
                if (currentTime > 86400) currentTime = 0;
                slider.value = currentTime;
            }
            
            const timeStr = formatTime(currentTime);
            clockDisplay.innerText = `${currentDateStr.replace(/-/g, '.')}  ${timeStr}`;

            if (deckgl && deckgl.props.layers.length > 0) {
                 const currentLayer = deckgl.props.layers[0].clone({
                     filterRange: [currentTime, currentTime + timeWindow]
                 });
                 deckgl.setProps({ layers: [currentLayer] });
            }

            requestAnimationFrame(animate);
        }

        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        }

        playBtn.onclick = () => { isPlaying = !isPlaying; playBtn.innerText = isPlaying ? "â¸" : "â–¶"; };
        slider.addEventListener('input', (e) => {
            currentTime = parseInt(e.target.value);
            if (!isPlaying && deckgl) {
                 const currentLayer = deckgl.props.layers[0].clone({
                     filterRange: [currentTime, currentTime + timeWindow]
                 });
                 deckgl.setProps({ layers: [currentLayer] });
                 clockDisplay.innerText = `${currentDateStr.replace(/-/g, '.')}  ${formatTime(currentTime)}`;
            }
        });

        initDateSelector();
        loadDataForDate(currentDateStr); 
    </script>
</body>
</html>