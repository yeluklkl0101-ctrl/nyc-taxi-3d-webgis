<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>NYC Taxi Monthly Data</title>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet" />
    <style>
        body { margin: 0; padding: 0; background: #000; font-family: 'Segoe UI', monospace; overflow: hidden; }
        #container { width: 100vw; height: 100vh; }
        
        /* æ§åˆ¶é¢æ¿ */
        #control-panel {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 80%; max-width: 600px;
            background: rgba(10, 10, 10, 0.9);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            padding: 20px;
            z-index: 10;
            color: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }

        /* é¡¶éƒ¨æ—¥æœŸå’Œæ—¶é—´æ˜¾ç¤º */
        .header-row {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px;
        }

        /* æ—¥æœŸé€‰æ‹©å™¨æ ·å¼ */
        select {
            background: #222; color: #fff; border: 1px solid #444;
            padding: 5px 10px; font-size: 16px; border-radius: 4px; cursor: pointer;
        }

        /* å¤§æ—¶é’Ÿ */
        #clock-display {
            font-size: 28px; font-weight: bold; color: #00ffcc;
            text-shadow: 0 0 8px rgba(0,255,204,0.3);
        }

        /* æ’­æ”¾æ§åˆ¶åŒº */
        .play-row { display: flex; align-items: center; gap: 15px; }
        button {
            background: #eee; border: none; padding: 6px 15px; border-radius: 4px;
            font-weight: bold; cursor: pointer;
        }
        button:hover { background: #00ffcc; }
        
        #slider-container { flex-grow: 1; display: flex; align-items: center; }
        input[type=range] { width: 100%; cursor: pointer; accent-color: #00ffcc; }
        
        #status { font-size: 12px; color: #888; text-align: center; margin-top: 5px; }
    </style>
</head>
<body>

    <div id="container"></div>

    <div id="control-panel">
        <div class="header-row">
            <div>
                <label>ğŸ“… é€‰æ‹©æ—¥æœŸ: </label>
                <select id="date-selector"></select>
            </div>
            <div id="clock-display">2025.07.01 00:00</div>
        </div>

        <div class="play-row">
            <button id="play-btn">â¸</button>
            <div id="slider-container">
                <input type="range" id="time-slider" min="0" max="86400" step="10" value="0">
            </div>
        </div>
        <div id="status">å‡†å¤‡å°±ç»ª</div>
    </div>

    <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
    <script src="https://unpkg.com/deck.gl@8.9.33/dist.min.js"></script>

    <script>
        const {DeckGL, ArcLayer, DataFilterExtension} = deck;
        const MAPBOX_TOKEN = 'pk.eyJ1IjoiMWRjajQiLCJhIjoiY21nNWN0ZXhwMDNjbTJqcWQ0aHR5NW5zcyJ9.Op7DM_smqoPKJVf2te3HQw'; 

        // å…¨å±€å˜é‡
        let currentDateStr = "2025-07-01"; // å½“å‰é€‰ä¸­çš„æ—¥æœŸå­—ç¬¦ä¸²
        let currentTime = 0;               // å½“å‰ç§’æ•° (0-86400)
        let isPlaying = true;
        let animationSpeed = 10;           // æ’­æ”¾é€Ÿåº¦
        const timeWindow = 3600;           // è½¨è¿¹æ‹–å°¾é•¿åº¦
        
        let deckgl = null; // DeckGL å®ä¾‹
        
        // DOM å…ƒç´ 
        const dateSelect = document.getElementById('date-selector');
        const clockDisplay = document.getElementById('clock-display');
        const slider = document.getElementById('time-slider');
        const playBtn = document.getElementById('play-btn');
        const statusEl = document.getElementById('status');

        // ğŸŸ¢ 1. åˆå§‹åŒ–æ—¥æœŸä¸‹æ‹‰èœå• (ç”Ÿæˆ 7æœˆ1æ—¥åˆ°7æœˆ31æ—¥)
        function initDateSelector() {
            for (let i = 1; i <= 31; i++) {
                const dayStr = i < 10 ? `0${i}` : `${i}`;
                const val = `2025-07-${dayStr}`;
                const option = document.createElement("option");
                option.value = val;
                option.text = val; // æ˜¾ç¤ºæ–‡æœ¬
                dateSelect.appendChild(option);
            }
            
            // ç›‘å¬æ—¥æœŸå˜åŒ–
            dateSelect.addEventListener('change', (e) => {
                loadDataForDate(e.target.value);
            });
        }

        // ğŸŸ¢ 2. åŠ è½½ç‰¹å®šæ—¥æœŸçš„æ•°æ®
        function loadDataForDate(dateStr) {
            currentDateStr = dateStr;
            statusEl.innerText = `æ­£åœ¨ä¸‹è½½ ${dateStr} çš„æ•°æ®...`;
            
            // æ„é€ æ–‡ä»¶å: trips_2025-07-10.json
            const fileName = `./trips_${dateStr}.json`;

            fetch(fileName)
                .then(res => {
                    if(!res.ok) throw new Error("æ–‡ä»¶ä¸å­˜åœ¨ (è¯·æ£€æŸ¥ python è„šæœ¬æ˜¯å¦ç”Ÿæˆäº†è¯¥æ—¥æœŸ)");
                    return res.json();
                })
                .then(data => {
                    statusEl.innerText = `âœ… ${dateStr}: åŠ è½½äº† ${data.length} æ¡è½¨è¿¹`;
                    updateDeckGL(data);
                })
                .catch(err => {
                    console.error(err);
                    statusEl.innerText = `âŒ åŠ è½½å¤±è´¥: ${fileName} æœªæ‰¾åˆ°`;
                    statusEl.style.color = 'red';
                    // å¦‚æœå¤±è´¥ï¼Œå°è¯•æ¸…ç©ºåœ°å›¾
                    updateDeckGL([]);
                });
        }

        // ğŸŸ¢ 3. æ›´æ–°æˆ–åˆå§‹åŒ– DeckGL
        function updateDeckGL(data) {
            // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ï¼Œåˆ›å»ºå®ä¾‹
            if (!deckgl) {
                deckgl = new DeckGL({
                    container: 'container',
                    mapboxApiAccessToken: MAPBOX_TOKEN,
                    mapStyle: 'mapbox://styles/mapbox/dark-v10',
                    initialViewState: {
                        longitude: -73.98, latitude: 40.75, zoom: 11, pitch: 50, bearing: -10
                    },
                    controller: true,
                    layers: []
                });
                requestAnimationFrame(animate); // å¯åŠ¨åŠ¨ç”»å¾ªç¯
            }

            // æ›´æ–°å›¾å±‚æ•°æ®
            const layer = new ArcLayer({
                id: 'taxi-arcs',
                data: data,
                getSourcePosition: d => d.from,
                getTargetPosition: d => d.to,
                getSourceColor: [0, 255, 200],
                getTargetColor: [255, 0, 100],
                getWidth: 2,
                extensions: [new DataFilterExtension({filterSize: 1})],
                getFilterValue: d => d.time,
                filterRange: [currentTime, currentTime + timeWindow], 
                opacity: 0.8
            });

            deckgl.setProps({ layers: [layer] });
        }

        // ğŸŸ¢ 4. åŠ¨ç”»å¾ªç¯
        function animate() {
            if (isPlaying) {
                currentTime += animationSpeed;
                if (currentTime > 86400) currentTime = 0;
                slider.value = currentTime;
            }
            
            // æ›´æ–° UI æ—¶é’Ÿï¼šç»„åˆ "æ—¥æœŸ" + "æ—¶é—´"
            const timeStr = formatTime(currentTime);
            // æ ¼å¼: 2025.07.01 08:30
            clockDisplay.innerText = `${currentDateStr.replace(/-/g, '.')}  ${timeStr}`;

            // æ›´æ–° DeckGL è¿‡æ»¤èŒƒå›´
            if (deckgl && deckgl.props.layers.length > 0) {
                 const currentLayer = deckgl.props.layers[0].clone({
                     filterRange: [currentTime, currentTime + timeWindow]
                 });
                 deckgl.setProps({ layers: [currentLayer] });
            }

            requestAnimationFrame(animate);
        }

        // è¾…åŠ©: ç§’è½¬æ—¶é—´
        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        }

        // äº¤äº’é€»è¾‘
        playBtn.onclick = () => { isPlaying = !isPlaying; playBtn.innerText = isPlaying ? "â¸" : "â–¶"; };
        slider.addEventListener('input', (e) => {
            currentTime = parseInt(e.target.value);
            // æ‹–æ‹½æ—¶æ‰‹åŠ¨è§¦å‘ä¸€æ¬¡æ›´æ–°ï¼Œé˜²æ­¢æš‚åœæ—¶ç”»é¢ä¸åŠ¨
            if (!isPlaying && deckgl) {
                 const currentLayer = deckgl.props.layers[0].clone({
                     filterRange: [currentTime, currentTime + timeWindow]
                 });
                 deckgl.setProps({ layers: [currentLayer] });
                 clockDisplay.innerText = `${currentDateStr.replace(/-/g, '.')}  ${formatTime(currentTime)}`;
            }
        });

        // ğŸš€ å¯åŠ¨ï¼
        initDateSelector();
        loadDataForDate(currentDateStr); // é»˜è®¤åŠ è½½ 7æœˆ1æ—¥

    </script>
</body>
</html>