<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>NYC Taxi WebGIS - Public Demo</title>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet" />
    <style>
        body { margin: 0; padding: 0; background: #000; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        #container { width: 100vw; height: 100vh; }
        
        #control-panel {
            position: absolute; top: 20px; left: 20px;
            width: 300px;
            background: rgba(10, 10, 10, 0.8);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            padding: 15px;
            z-index: 10;
            color: white;
        }
        select { background: #222; color: #fff; border: 1px solid #444; width: 100%; margin-bottom: 10px; padding: 5px; }
        #clock-display { font-size: 20px; font-weight: bold; color: #00ffcc; margin-bottom: 10px; }
        button { background: #eee; border: none; padding: 5px 15px; border-radius: 4px; cursor: pointer; }
        input[type=range] { width: 100%; accent-color: #00ffcc; }
        
        /* 仅保留可视化说明，移除 AI 面板相关样式 */
        .note { font-size: 12px; color: #888; margin-top: 10px; line-height: 1.5; }
    </style>
</head>
<body>

    <div id="container"></div>

    <div id="control-panel">
        <div id="clock-display">2025.07.01 00:00</div>
        <select id="date-selector"></select>
        <div style="display:flex; gap:10px; align-items:center;">
            <button id="play-btn">⏸</button>
            <input type="range" id="time-slider" min="0" max="86400" step="10" value="0">
        </div>
        <div style="font-size:12px; color:#aaa; margin-top:5px;">拖动滑块查看不同时间段</div>
        
        <div class="note">
            <hr style="border:0; border-top:1px solid #333; margin: 10px 0;">
            <strong>演示说明：</strong><br>
            这是一个纯前端 WebGIS 演示。<br>
            AI 智能分析、热点统计与数据库功能<br>
            请运行本地 Python 版本 (index_local.html)。
        </div>
    </div>

    <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
    <script src="https://unpkg.com/deck.gl@8.9.33/dist.min.js"></script>

    <script>
        const {DeckGL, ArcLayer, DataFilterExtension} = deck;
        const MAPBOX_TOKEN = 'pk.eyJ1IjoiMWRjajQiLCJhIjoiY21nNWN0ZXhwMDNjbTJqcWQ0aHR5NW5zcyJ9.Op7DM_smqoPKJVf2te3HQw'; 
        
        let currentDateStr = "2025-07-01"; 
        let currentTime = 0;              
        let isPlaying = true;
        let animationSpeed = 20;
        const timeWindow = 3600;
        let deckgl = null; 
        
        const dateSelect = document.getElementById('date-selector');
        const clockDisplay = document.getElementById('clock-display');
        const slider = document.getElementById('time-slider');
        const playBtn = document.getElementById('play-btn');

        function initDateSelector() {
            for (let i = 1; i <= 31; i++) {
                const dayStr = i < 10 ? `0${i}` : `${i}`;
                const val = `2025-07-${dayStr}`;
                const option = document.createElement("option");
                option.value = val;
                option.text = val;
                dateSelect.appendChild(option);
            }
            dateSelect.addEventListener('change', (e) => loadDataForDate(e.target.value));
        }

        function loadDataForDate(dateStr) {
            currentDateStr = dateStr;
            const fileName = `./trips_${dateStr}.json`;
            // 此处恢复为读取本地 JSON 文件
            fetch(fileName).then(res => { if(!res.ok) throw new Error("File not found"); return res.json(); })
                .then(data => updateDeckGL(data)).catch(err => updateDeckGL([]));
        }

        function updateDeckGL(data) {
            if (!deckgl) {
                deckgl = new DeckGL({
                    container: 'container',
                    mapboxApiAccessToken: MAPBOX_TOKEN,
                    mapStyle: 'mapbox://styles/mapbox/dark-v10',
                    initialViewState: { longitude: -73.98, latitude: 40.75, zoom: 11, pitch: 50, bearing: -10 },
                    controller: true,
                    layers: []
                });
                requestAnimationFrame(animate); 
            }
            const layer = new ArcLayer({
                id: 'taxi-arcs',
                data: data,
                getSourcePosition: d => d.from,
                getTargetPosition: d => d.to,
                getSourceColor: [0, 255, 200],
                getTargetColor: [255, 0, 100],
                getWidth: 2,
                extensions: [new DataFilterExtension({filterSize: 1})],
                getFilterValue: d => d.time,
                filterRange: [currentTime, currentTime + timeWindow], 
                opacity: 0.8
            });
            deckgl.setProps({ layers: [layer] });
        }

        function animate() {
            if (isPlaying) {
                currentTime += animationSpeed;
                if (currentTime > 86400) currentTime = 0;
                slider.value = currentTime;
            }
            const timeStr = formatTime(currentTime);
            clockDisplay.innerText = `${currentDateStr.replace(/-/g, '.')}  ${timeStr}`;
            if (deckgl && deckgl.props.layers.length > 0) {
                 const currentLayer = deckgl.props.layers[0].clone({ filterRange: [currentTime, currentTime + timeWindow] });
                 deckgl.setProps({ layers: [currentLayer] });
            }
            requestAnimationFrame(animate);
        }

        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        }

        playBtn.onclick = () => { isPlaying = !isPlaying; playBtn.innerText = isPlaying ? "⏸" : "▶"; };
        slider.addEventListener('input', (e) => {
            currentTime = parseInt(e.target.value);
            if (!isPlaying && deckgl) {
                 const currentLayer = deckgl.props.layers[0].clone({ filterRange: [currentTime, currentTime + timeWindow] });
                 deckgl.setProps({ layers: [currentLayer] });
                 clockDisplay.innerText = `${currentDateStr.replace(/-/g, '.')}  ${formatTime(currentTime)}`;
            }
        });

        initDateSelector();
        loadDataForDate(currentDateStr);
        // AI 模块已移除，安全用于 GitHub Pages 展示
    </script>
</body>
</html>